---
title: "[UniRx] UniRx 기록 1"
categories:
  - UniRx
tags:
  - UnityC#
  - UniRx
toc: true
toc_sticky: true
toc_label: "UniRx 기록 1"
toc_icon: "sticky-note"
---

# 참고 문헌

🔺 [UniRx入門 その1](https://qiita.com/toRisouP/items/2f1643e344c741dd94f8){:target="_blank"} 원본 링크. <br>
- <https://qiita.com/toRisouP/items/2f1643e344c741dd94f8> <br>

🔺 [UniRx 입문 1](https://tech.lonpeach.com/2019/11/03/UniRx-Getting-Started-1/){:target="_blank"} 원본 구글번역 링크. <br>
- <https://tech.lonpeach.com/2019/11/03/UniRx-Getting-Started-1/> <br>

# 1. "event와 UniRx"

### 테이블 구성
  * [Event](#TimeCounter.cs)

```cs
using System.Collections;
using UnityEngine;

/// <summary>
/// 100에서 카운트 다운 값을 보고하는 샘플
/// </summary>
public class TimeCounter : MonoBehaviour
{
    /// <summary>
    /// 이벤ㅌ 핸들러 (이벤트 메시지의 형식 정의)
    /// </summary>
    public delegate void TimerEventHandler(int time);

    /// <summary>
    /// 이벤트
    /// </summary>
    public event TimerEventHandler OnTimeChanged;

    private void Start()
    {
        // 타이머 시작
        StartCoroutine(TimerCoroutine());        
    }

    private IEnumerator TimerCoroutine()
    {
        // 100에서 카운트 다운
        var time = 100;
        while (time > 0)
        {
            time--;

            // 이벤트 알림
            OnTimeChanged(time);

            // 1초 기다리는
            yield return new WaitForSeconds(1);
        }
    }
}
```

  * [Event](#TimerView.cs)

```cs
using UnityEngine;
using UnityEngine.UI;

public class TimerView : MonoBehaviour
{
    // 각 인스턴스는 인스펙터에서 설정
    [SerializeField] private TimeCounter timeCounter;
    [SerializeField] private Text counterText; // UGUI의 Text

    private void Start()
    {
        // 타이머 카운터가 변화한 이벤트를 받고 UGUI Text를 업데이트
        timeCounter.OnTimeChanged += time => // "=>" 는 람다식이라는 익명 함수 표기법 
        {
            // 현재 타이머 값을 UI에 반영
            counterText.text = time.ToString();
        };
    }
}
```

***

  * [UniRx](#TimeCounterRx.cs)

```cs
using System;
using System.Collections;
using UniRx;
using UnityEngine;

/// <summary>
/// 100에서 카운트 다운하고 Debug.Log에 그 값을 표시하는 샘플
/// </summary>
public class TimeCounterRx : MonoBehaviour
{
    // 이벤트를 발행하는 핵심 인스턴스
    private Subject<int> timerSubject = new Subject<int>();

    // 이벤트의 구독자만 공개
    public IObservable<int> OnTimeChanged => timerSubject;

    private void Start() => StartCoroutine(TimerCoroutine());

    private IEnumerator TimerCoroutine()
    {
        // 100에서 카운트 다운
        var time = 100;
        while (time > 0)
        {
            time--;

            // 이벤트를 발행
            timerSubject.OnNext(time);

            // 1초 기다리는
            yield return new WaitForSeconds(1);
        }
    }
}
```

  * [UniRx](#TimerViewRx)

```cs
using UnityEngine;
using UnityEngine.UI;
using UniRx;

public class TimerViewRx : MonoBehaviour
{
    // 각 인스턴스는 인스펙터에서 설정
    [SerializeField] private TimeCounterRx timeCounter;
    [SerializeField] private Text counterText; // UGUI의 Text

    private void Start() =>
        // 타이머 카운터가 변화한 이벤트를 받고 UGUI Text를 업데이트
        timeCounter.OnTimeChanged.Subscribe(time =>
        {
            // 현재 타이머 값을 ui에 반영
            counterText.text = time.ToString();
        });
}
```
***
## 2. "OnNext와 Subscribe"
```cs
private void Start()
{
    // Subject 작성
    Subject<string> subject = new Subject<string>();

    // 3회 Subscrbie
    subject.Subscribe(msg => Debug.Log("Subscribe1 : " + msg));
    subject.Subscribe(msg => Debug.Log("Subscribe2 : " + msg));
    subject.Subscribe(msg => Debug.Log("Subscribe3 : " + msg));

    // 이벤트 메시지 발행
    subject.OnNext("안녕하세요");
    subject.OnNext("안녕");
}
```
```
Subscribe1 : 안녕하세요
Subscribe2 : 안녕하세요
Subscribe3 : 안녕하세요
Subscribe1 : 안녕
Subscribe2 : 안녕
Subscribe3 : 안녕
```
***
## 4. "IObserver와 IObservable"
***
## (보충) Subscribe의 생략 호출
```
// OnNext만
subject.Subscribe(msg => Debug.Log("Subscribe1:" + msg));

// OnNext & OnError
subject.Subscribe(
    msg => Debug.Log("Subscribe1:" + msg),
    error => Debug.LogError("Error" + error));

// OnNext & OnCompleted
subject.Subscribe(
    msg => Debug.Log("Subscribe1:" + msg),
    () => Debug.Log("Completed"));

// OnNext & OnError & OnCompleted
subject.Subscribe(
    msg => Debug.Log("Subscribe1:" + msg),
    error => Debug.LogError("Error" + error),
    () => Debug.Log("Completed"));
```
***
## 필터링 운영자 "Where"
```cs
// 문자열을 발행하는 Subject
Subject<string> subject = new Subject<string>();

// Enemy만 필터링
subject
    .Where(x => x == "Enemy") // 필터링 오퍼레이터
    .Subscribe(x => Debug.Log($"플레이어가 {x}에 충돌했습니다."));

// 이벤트 메시지 발급
// 플레이어가 언급한 개체의 Tag가 발행되었다는 가정
subject.OnNext("Wall");
subject.OnNext("Wall");
subject.OnNext("Enemy");
subject.OnNext("Enemy");
```
```
플레이어가 Enemy에 충돌했습니다.
플레이어가 Enemy에 충돌했습니다.
```
***

## 다양한 오퍼레이터
- 필터링 "Where"
- 메시지 변환 "Select"
- 중복을 제거하는 "Distinct"
- 일정 개수가 올때까지 대기하는 "Buffer"
- 단시간에 함께 온 경우 처음만 사용하는 "ThrottleFirst"
***

## 필터링 오퍼레이터 구현
```cs
using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

/// <summary>
/// 필터링 오퍼레이터
/// </summary>
public class MyFilter<T> : IObservable<T>
{
    /// <summary>
    /// 상류가 되는 Observable
    /// </summary>
    private IObservable<T> _source;

    /// <summary>
    /// 판정식
    /// </summary>
    private Func<T, bool> _conditionalFunc;

    public MyFilter(IObservable<T> source, Func<T, bool> conditionalFunc)
    {
        _source = source;
        _conditionalFunc = conditionalFunc;
    }
    
    public IDisposable Subscribe(IObserver<T> observer)
    {
        // Subscribe되면 MyFilterOperator 본체를 만들어 반환한다.
        return new MyFilterInternal(this, observer).Run();
    }
    
    // Observer로 MyFilterInternal이 실제로 작동하는 곳
    private class MyFilterInternal : IObserver<T>
    {
        private MyFilter<T> _parent;
        private IObserver<T> _observer;
        private object _lockObject = new object();

        public MyFilterInternal(MyFilter<T> parent, IObserver<T> observer)
        {
            _parent = parent;
            _observer = observer;
        }

        public IDisposable Run()
        {
            return _parent._source.Subscribe(this);
        }

        public void OnNext(T value)
        {
            lock (_lockObject)
            {
                if (_observer == null)
                {
                    return;
                }

                try
                {
                    // 같은 경우에만 OnNext를 통과
                    if (_parent._conditionalFunc(value))
                    {
                        _observer.OnNext(value);
                    }
                }
                catch (Exception e)
                {
                    // 도중에 에러가 발생하면 에러를 전송
                    _observer.OnError(e);
                    _observer = null;
                }
            }
        }

        public void OnError(Exception error)
        {
            lock (_lockObject)
            {
                // 오류를 전파하고 정지
                _observer.OnError(error);
                _observer = null;
            }
        }
        
        public void OnCompleted()
        {
            lock (_lockObject)
            {
                // 정지
                _observer.OnCompleted();
                _observer = null;
            }
        }
    }
}
```

- C# lock 블럭
- C# Interlocked
- C# 예외처리

***
## 사용성을 고려하여 확장 메서드 작성
```cs
using System;

public static class ObservableOperators
{
    public static IObservable<T> FilterOperator<T>(this IObservable<T> source, Func<T, bool> conditionalFunc) 
        => new MyFilter<T>(source, conditionalFunc);
} 
```
```cs
private void Start()
{
    // 문자열을 발행하는 Subject 
    Subject<string> subject = new Subject<string>();

    // filter를 끼고 Subscribe 보면 
    subject
        .FilterOperator(x => x == "Enemy")
        .Subscribe(x => Debug.Log(string.Format("플레이어가 {0}에 충돌했습니다", x)));

    // 이벤트 메시지 발급 
    // 플레이어가 언급 한 개체의 Tag가 발행되어, 같은 가정 
    subject.OnNext("Wall");
    subject.OnNext("Wall");
    subject.OnNext("Enemy");
    subject.OnNext("Enemy");
}
```
```
플레이어가 Enemy에 충돌했습니다
플레이어가 Enemy에 충돌했습니다
```

<!--
📣<br>
**Beakjoon**에서 PASS된 코드만 업데이트합니다.<br>
알고리즘을 먼저 풀이하는 언어(Java)가 정해져있어, 
풀이 언어(Python, C++, Java)가 모두 업데이트될 때까지는 시간이 걸릴 수 있습니다.
{: .notice--primary}

📌 **작성자 개발 환경** <br>
**OS** : Windows 10<br>
{: .notice--primary}
-->

<!-- 

|  언어  | Markdown | 언어 | Markdown |
| :---: | :---: | :---: | :---: |
| Bash | bash | JSON | json |
| C# | cs | Java | java |
| C++ | cpp | JavaScript | javascript |
| CSS | css | PHP | php |
| Diff | diff | Perl | perl |
| HTML, XML | html | Python | python |
| HTTP | http | Ruby | ruby |
| Ini | ini | SQL | sql |

<br>

***
___
___

---

-->

<!-- 
언어 | Markdown | 언어 | Markdown
---|:---:|:---:|---:
Bash | bash | JSON | json

  값 | 의미 | 기본값
---|:---:|---:
`static` | 유형(기준) 없음 / 배치 불가 | `static`
`relative` | 요소 **자신** 기준으로 배치 |
`absolute` | 위치 상 **_부모_(조상)요소** 기준으로 배치 |
`fixed` | **브라우저 창** 기준으로 배치 |

  A (기본 왼쪽 정렬) | B (가운데 정렬) | C (오른쪽 정렬)
---|:---:|---:
`1` | 가나다라 | abc
`2` | 가나다라마 | abcd
`3` | 가나다라마바 | abcde
`4` | 가나다라마바사 | abcdef

언어  Markdown  언어  Markdown
Bash  bash  JSON  json
C#  cs  Java  java
C++ cpp JavaScript  javascript
CSS css PHP php
Diff  diff  Perl  perl
HTML, XML html  Python  python
HTTP  http  Ruby  ruby
Ini ini SQL sql

<div align=right>(🔺많이 참고했던 공식 홈페이지입니다! 원문이라 낯설지만 왠만한건 다 적혀있습니다.)</div>
<br>

# H1
## H2
### H3
#### H4
##### H5
###### H6

> first blockqute
>> second blockqute
>>> third blockqute

*single asterisks* - 기울임체
_single underscores_ - 기울임체
**double asterisks** - 굵은글씨체
__double underscores__ - 기울임체/굵은글씨체
***triple underscores*** - 기울임체/굵은글씨체
~~cancelline~~ - 취소줄


- [minimal-mistakes theme 공식 홈페이지](https://mmistakes.github.io/minimal-mistakes/)
- [minimal-mistakes 가이드](https://mmistakes.github.io/minimal-mistakes/docs/quick-start-guide/)
- [minimal-mistakes Github Link](https://github.com/mmistakes/minimal-mistakes)

<br>
<b><u><span style="font-size:20px">문제</span></u></b>

두 정수 A와 B를 입력받은 다음, A+B를 출력하는 프로그램을 작성하시오.

<br>
<b><u><span style="font-size:20px">입력</span></u></b>

첫째 줄에 A와 B가 주어진다. (0 < A, B < 10)

<br>
<b><u><span style="font-size:20px">출력</span></u></b>

첫째 줄에 A+B를 출력한다.

<br>
<br>

# 문제 풀이

---

깊게 설명할 내용이 없습니다 😀<br>
정수는 두개가 입력되며, 이 결과를 한 줄에 출력하면 됩니다.<br>

<br>
<br>

# 문제 코드

## C# 코드 "event 와 UniRx"

<script src="https://gist.github.com/eona1301/ffc5be1f747f3833d2eba0b4c98fa310.js"></script>

2번 라인은 string list를 int list로 변경해주는 코드입니다.<br>

## C++

<script src="https://gist.github.com/eona1301/e9e90dcd958e17e20f24a444bd96c2b7.js"></script>

## Java

<script src="https://gist.github.com/eona1301/9856371899c367462a8b4df8cdff3fc4.js"></script>

<br>
<br>

# 제출 결과


![image](https://user-images.githubusercontent.com/45550607/107748563-9a6a2b00-6d5c-11eb-98fc-dadb97e1b8b6.png){: .image-center}
-->